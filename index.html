<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA 核心設定 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    
    <!-- iOS 專用設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="語音計時">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <title>按摩語音倒數計時器</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --highlight-color: #ffd700;
            --btn-bg: #333333;
            --btn-text: #ffffff;
            --btn-active: #555555;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            box-sizing: border-box;
            user-select: none; 
            -webkit-user-select: none;
            overscroll-behavior: none;
        }

        h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #ccc;
            margin-top: 0;
        }

        #timer-display {
            font-size: 6rem;
            font-weight: bold;
            color: var(--highlight-color);
            margin: 20px 0;
            font-variant-numeric: tabular-nums;
            line-height: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        #status-text {
            font-size: 1.5rem;
            margin-bottom: 30px;
            min-height: 2rem;
            color: #aaa;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            max-width: 500px;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .full-width {
            grid-column: span 2;
        }

        button {
            background-color: var(--btn-bg);
            color: var(--btn-text);
            border: 3px solid #fff;
            border-radius: 15px;
            padding: 25px 10px;
            font-size: 1.8rem;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            touch-action: manipulation;
            outline: none;
            position: relative;
            overflow: hidden;
            width: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        button:active {
            transform: scale(0.96);
            background-color: var(--btn-active);
        }

        button:focus-visible {
            box-shadow: 0 0 0 4px var(--highlight-color);
            border-color: var(--highlight-color);
        }

        #btn-start { background-color: #006400; font-weight: bold; }
        #btn-pause { background-color: #8b0000; font-weight: bold; }
        .btn-add { border-color: var(--highlight-color); color: var(--highlight-color); }

        .progress-container {
            width: 100%;
            max-width: 500px;
            height: 12px;
            background-color: #444;
            border-radius: 6px;
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid #666;
        }
        
        #progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--highlight-color);
            transition: width 1s linear;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* 隱藏的 Video (iOS Wake Lock Hack) */
        #wake-lock-video {
            position: absolute;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
        }

        @media (max-width: 480px) {
            #timer-display { font-size: 4.5rem; }
            button { font-size: 1.5rem; padding: 20px 5px; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <h2>按摩語音計時器</h2>

    <div class="progress-container" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div id="progress-bar"></div>
    </div>

    <div id="timer-display" aria-live="polite" aria-label="剩餘時間">00:00</div>
    <div id="status-text" aria-live="polite">準備中</div>

    <!-- Wake Lock Video -->
    <video id="wake-lock-video" playsinline muted loop>
        <source src="data:video/mp4;base64,AAAAHGZ0eXBNNEVCAAAATTRQVXZpZGVvZgAAAAEAAABxdmRhdHgAAAAAAAAAIQAABh5tZWF0O3d3dy5mb3JibddeLmNvbQAAACBjZHRhZEtyb246MTYuMC4xLjA6MjAxNS0xMC0yNQAAAAAkdXVpZFBPV0VSDwAAADBweHBkbTxsAABWcEdQUwAAAAAAAAB7bW9vdgAAAGxtdmhkAAAAAAAAAAAAAAAAAAAD6AAAA+gAAQAAAQAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAmB0cmFrAAAAXHRraGQAAAADAAAAAAAAAAAAAAABAAAAAAAAA+gAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAFAAAAA4AAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAPoAAAAAAABAAAAAAKobWRpYQAAACBtZGhkAAAAAAAAAAAAAAAAAAAD6AAAA+gAAAAAAhAAAABhaGRscgAAAAAAAAAAdmlkZQAAAAAAAAAAAAAAAFZpZGVvSGFuZGxlcgAAAAFzbWluZgAAABR2bWhkAAAAAQAAAAAAAAAAAAAAJGRpbmYAAAAcZHJlZgAAAAAAAAABAAAADHVybCAAAAABAAABMHN0YmwAAACkc3RzZAAAAAAAAAABAAAAhGF2YzEAAAAAAAAAAQAAAAA4BQAAAAEAAAAAAAAAAAAAAAAAAAAAABj//wAAADFhdmNDAQAAAAAAAAAAAAAAIAAAAC5zcHJpdGUgZW5jb2RlciBhcnRpZmFjdHMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABhzdHRzAAAAAAAAAAEAAAAFAAAAIAAAABRzdHNzAAAAAAAAAAEAAAABAAAAHHN0c2MAAAAAAAAAAQAAAAEAAAAFAAAAAQAAABRzdHpQAAAAAAAABQAAABgAAAAUc3RjbwAAAAAAAAABAAAAMAAAAGx1ZHRhAAAAZHRpdGwAAAAAdHdlZW5hcnQubmV0AAAAYWF1dGgAAAAAdHdlZW5hcnQubmV0AAAAXGNweXQAAAAAdHdlZW5hcnQubmV0AAAAMGRzY3AAAAAAdHdlZW5hcnQubmV0" type="video/mp4">
    </video>

    <div class="controls">
        <button id="btn-10" class="btn-add" onclick="addTime(10)">+10 分<span class="sr-only">鐘</span></button>
        <button id="btn-1" class="btn-add" onclick="addTime(1)">+1 分<span class="sr-only">鐘</span></button>
        <button id="btn-start" class="full-width">開始計時<div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">(長按 2 秒歸零)</div></button>
        <button id="btn-pause" class="full-width" onclick="togglePause()">暫停 / 繼續</button>
    </div>

    <script>
        // PWA Service Worker 註冊
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW registered!', reg))
                    .catch(err => console.log('SW failed', err));
            });
        }

        let totalTimeSeconds = 0; 
        let remainingSeconds = 0; 
        let timerInterval = null; 
        let isRunning = false;    
        let isPaused = false;
        let wakeLock = null;
        
        const displayEl = document.getElementById('timer-display');
        const statusEl = document.getElementById('status-text');
        const progressBarEl = document.getElementById('progress-bar');
        const progressContainer = document.querySelector('.progress-container');
        const startBtn = document.getElementById('btn-start');
        const wakeLockVideo = document.getElementById('wake-lock-video');

        const synth = window.speechSynthesis;
        let voice = null;

        function initVoice() {
            const voices = synth.getVoices();
            voice = voices.find(v => v.lang === 'zh-TW') || 
                    voices.find(v => v.lang === 'zh-HK') || 
                    voices.find(v => v.lang === 'zh-CN') || null;
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = initVoice;
        }
        initVoice(); 

        function speak(text) {
            if (synth.speaking) synth.cancel(); 
            const utterance = new SpeechSynthesisUtterance(text);
            if (voice) utterance.voice = voice;
            utterance.rate = 1.0; 
            utterance.lang = 'zh-TW';
            synth.speak(utterance);
        }

        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => console.log('Wake Lock released'));
                } catch (err) { console.error(err); }
            }
            if (wakeLockVideo) {
                try { wakeLockVideo.play().catch(e => console.log(e)); } catch(e) {}
            }
        }

        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release().then(() => wakeLock = null).catch(e => console.error(e));
            }
            if (wakeLockVideo) wakeLockVideo.pause();
        }

        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
            }
        });

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function updateDisplay() {
            displayEl.textContent = formatTime(remainingSeconds);
            if (totalTimeSeconds > 0) {
                const percentage = ((totalTimeSeconds - remainingSeconds) / totalTimeSeconds) * 100;
                progressBarEl.style.width = `${percentage}%`;
                progressContainer.setAttribute('aria-valuenow', Math.round(percentage));
            } else {
                progressBarEl.style.width = '0%';
                progressContainer.setAttribute('aria-valuenow', 0);
            }
        }

        function addTime(minutes) {
            if (isRunning && !isPaused) {
                speak("計時中，無法增加時間");
                return;
            }
            remainingSeconds += minutes * 60;
            totalTimeSeconds = remainingSeconds; 
            updateDisplay();
            speak(`加 ${minutes} 分鐘，目前 ${Math.floor(remainingSeconds/60)} 分鐘`);
            statusEl.textContent = "準備開始";
        }

        function startTimer() {
            if (remainingSeconds <= 0) {
                speak("請先設定時間");
                return;
            }
            if (isRunning && !isPaused) return; 
            if (isPaused) {
                speak("請按暫停鍵繼續");
                return;
            }
            isRunning = true;
            isPaused = false;
            totalTimeSeconds = remainingSeconds; 
            const mins = Math.floor(remainingSeconds / 60);
            statusEl.textContent = "計時中...";
            speak(`按摩時間 ${mins} 分鐘，計時開始`);
            requestWakeLock();
            runInterval();
        }

        function runInterval() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (remainingSeconds > 0) {
                    remainingSeconds--;
                    updateDisplay();
                    checkAnnouncements();
                } else {
                    finishTimer();
                }
            }, 1000);
        }

        function checkAnnouncements() {
            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;
            if (seconds === 0 && remainingSeconds > 0) {
                if (minutes < 5) speak(`剩餘 ${minutes} 分鐘`);
                else if (minutes % 5 === 0) speak(`剩餘 ${minutes} 分鐘`);
            }
        }

        function togglePause() {
            if (!isRunning && remainingSeconds > 0) {
                speak("請先按開始計時");
                return;
            }
            if (remainingSeconds <= 0) return;

            if (isPaused) {
                isPaused = false;
                statusEl.textContent = "計時中...";
                speak("繼續計時");
                requestWakeLock();
                runInterval();
            } else {
                isPaused = true;
                clearInterval(timerInterval);
                releaseWakeLock();
                statusEl.textContent = "已暫停";
                speak("暫停計時");
            }
        }

        function finishTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            isPaused = false;
            remainingSeconds = 0;
            updateDisplay();
            statusEl.textContent = "時間到";
            speak("時間到，按摩結束");
            releaseWakeLock();
            
            let flashCount = 0;
            const flashInterval = setInterval(() => {
                document.body.style.backgroundColor = flashCount % 2 === 0 ? "#550000" : "var(--bg-color)";
                flashCount++;
                if (flashCount > 5) {
                    clearInterval(flashInterval);
                    document.body.style.backgroundColor = "var(--bg-color)";
                }
            }, 500);
        }

        function resetTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            isPaused = false;
            remainingSeconds = 0;
            totalTimeSeconds = 0;
            updateDisplay();
            statusEl.textContent = "已歸零";
            speak("計時歸零");
            releaseWakeLock();
        }

        let pressTimer;
        let isLongPress = false;
        const startPress = (e) => {
            isLongPress = false;
            pressTimer = setTimeout(() => {
                isLongPress = true;
                resetTimer(); 
                if (navigator.vibrate) navigator.vibrate(200);
            }, 2000); 
        };
        const endPress = (e) => clearTimeout(pressTimer);

        startBtn.addEventListener('mousedown', startPress);
        startBtn.addEventListener('touchstart', startPress, {passive: true});
        startBtn.addEventListener('mouseup', endPress);
        startBtn.addEventListener('touchend', endPress);
        startBtn.addEventListener('mouseleave', () => clearTimeout(pressTimer)); 
        startBtn.addEventListener('click', (e) => {
            if (isLongPress) {
                e.stopImmediatePropagation();
                e.preventDefault();
            } else {
                startTimer();
            }
        });
    </script>
</body>
</html>